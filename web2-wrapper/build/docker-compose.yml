# Copyright (c) 2022-2023 - for information on the respective copyright owner
# see the NOTICE file and/or the repository at
# https://github.com/catenax-ng/product-esc-backbone-code
#
# SPDX-License-Identifier: Apache-2.0
version: '3.8'

services:
  nats1:
    container_name: nats1
    env_file:
      - .env
    image: nats:${NATS_IMAGE_HASH}
    ports:
      - "4222:4222"
      - "8222:8222"
    restart: always
    command: --js --sd /data -p 4222
    networks:
      - nats1
  wrapper1-init:
    container_name: wrapper1-init
    env_file:
      - .env
    image: ghcr.io/catenax-ng/esc-res-sync-web2-wrapper:${WRAPPER_IMAGE_HASH}
    command:
      - /wrapper/init.sh
      - wrapper1
      - "nats://nats1:4222"
    volumes:
      - ${WRAPPER1_HOME}:/wrapper/config
  wrapper1:
    container_name: wrapper1
    env_file:
      - .env
    image: ghcr.io/catenax-ng/esc-res-sync-web2-wrapper:${WRAPPER_IMAGE_HASH}
    volumes:
      - ${WRAPPER1_HOME}:/wrapper/config
    depends_on:
      wrapper1-init:
        condition: service_completed_successfully
      nats1:
        condition: service_started
    networks:
      - nats1
  nats2:
    container_name: nats2
    env_file:
      - .env
    image: nats:${NATS_IMAGE_HASH}
    ports:
      - "4223:4222"
      - "8223:8222"
    restart: always
    command: --js --sd /data -p 4222
    networks:
      - nats2
  wrapper2-init:
    container_name: wrapper2-init
    env_file:
      - .env
    image: ghcr.io/catenax-ng/esc-res-sync-web2-wrapper:${WRAPPER_IMAGE_HASH}
    command:
      - /wrapper/init.sh
      - wrapper2
      - "nats://nats2:4222"
    volumes:
      - ${WRAPPER2_HOME}:/wrapper/config
  wrapper2:
    container_name: wrapper2
    env_file:
      - .env
    image: ghcr.io/catenax-ng/esc-res-sync-web2-wrapper:${WRAPPER_IMAGE_HASH}
    volumes:
      - ${WRAPPER2_HOME}:/wrapper/config
    depends_on:
      wrapper2-init:
        condition: service_completed_successfully
      nats2:
        condition: service_started
    networks:
      - nats2
networks:
  nats1:
    name: "nats1"
  nats2:
    name: "nats2"
