# Copyright (c) 2022-2023 Contributors to the Eclipse Foundation
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License, Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
#
# SPDX-License-Identifier: Apache-2.0
# syntax=docker/dockerfile:1.4
FROM golang:1.19.1-bullseye as esc-backbone-build-base
ENV PACKAGES bash curl sed
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y $PACKAGES && \
    apt-get clean

WORKDIR /build/esc-backbone
COPY go.mod go.sum ./
RUN go mod download

RUN go install github.com/tomwright/dasel/cmd/dasel@v1.26.1
WORKDIR /output
RUN cp `which dasel` /output

RUN curl https://get.ignite.com/cli@v0.27.1! | bash

ONBUILD RUN apt-get update && \
            apt-get upgrade -y && \
            apt-get remove --purge --auto-remove -y && \
            apt-get clean

FROM debian:11.5-slim as esc-backbone-debian-base
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get remove --purge --auto-remove -y && \
    apt-get clean

ONBUILD RUN apt-get update && \
            apt-get upgrade -y && \
            apt-get remove --purge --auto-remove -y && \
            apt-get clean

FROM node:17.9 as esc-backbone-web-build-base
WORKDIR /output/web
COPY web/package.json web/package-lock.json ./
RUN npm install

FROM nginxinc/nginx-unprivileged:1.23 as esc-backbone-web-base
USER 0
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y jq &&  \
    apt-get remove --purge --auto-remove -y && \
    apt-get clean

ONBUILD USER 0
ONBUILD RUN apt-get update && \
            apt-get upgrade -y && \
            apt-get remove --purge --auto-remove -y && \
            apt-get clean